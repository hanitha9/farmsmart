<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmSmart - Precision Agriculture</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACYSURBVFhH7ZYxDoAgDEQ7///0YgqWdpA+2MJoO0iPFiJABbYJYUwC4Xme5zFKBZmZeV4a8xH4qYg6dQeR5wloZma+Av8K0Mzs9yD/BrCzswf5N4Cdne0g/wZwZ+eP5C8AOzv7kH8D2NnZG/k3gJ2dPZK/AOzs7IH8G8DOzh7k3wB2dvZA/g1gZ2cP5N8Adna2g/wbwM7OHuTfAHZ29kD+DWBNuLshOifhAAAAAElFTkSuQmCC">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: url('https://optcms.s3.ca-central-1.amazonaws.com/www.indiavsdisinformation.com/2023/202302/20230226-wsfl20230227131as.jpg') no-repeat center center fixed;
            background-size: cover;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }
        .hidden {
            display: none;
        }
        .crop-card {
            transition: transform 0.3s;
            border: 1px solid #e5e7eb;
        }
        .crop-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .crop-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .navbar-tabs {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .navbar-tabs a {
            transition: color 0.3s;
        }
        .navbar-tabs a:hover {
            text-decoration: none !important;
        }
        .navbar-tabs a.active {
            color: #a7f3d0;
            font-weight: bold;
        }
        .navbar-tabs a:focus {
            outline: 2px solid #a7f3d0;
            outline-offset: 2px;
        }
        #crop-details {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }
        .stage-image {
            max-width: 300px;
            height: auto;
            margin-top: 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navbar -->
    <nav class="bg-green-700 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">FarmSmart</h1>
            <div class="navbar-tabs">
                <a href="#" id="farm-input-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="farm-input" aria-selected="false" tabindex="0">Farm Input</a>
                <a href="#" id="recommendations-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="recommendations" aria-selected="false" tabindex="0">Recommendations</a>
                <a href="#" id="schedule-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="schedule" aria-selected="false" tabindex="0">Generate Schedule</a>
                <a href="#" id="crop-details-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="crop-details" aria-selected="false" tabindex="0">Crop Details</a>
                <a href="#" id="moisture-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="moisture" aria-selected="false" tabindex="0">Moisture Level</a>
                <a href="#" id="motor-status-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="motor-status" aria-selected="false" tabindex="0">Motor Status</a>
                <a href="#" id="notifications-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="notifications" aria-selected="false" tabindex="0">Notifications</a>
                <a href="#" id="pesticides-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="pesticides" aria-selected="false" tabindex="0">Organic Pesticides</a>
                <a href="#" id="progress-tab" class="text-white hover:text-green-200 hidden" role="tab" aria-controls="progress" aria-selected="false" tabindex="0">Crop Progress</a>
                <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Tab Content -->
    <div class="container mx-auto p-6">
        <div id="tab-content">
            <!-- Login Page -->
            <div id="login" class="min-h-screen flex items-center justify-center" role="tabpanel" aria-labelledby="farm-input-tab">
                <div class="login-container p-8 rounded-lg shadow-lg max-w-md text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-4">Welcome to FarmSmart</h2>
                    <p class="text-gray-600 mb-6">Empowering Indian farmers with precision agriculture. Over 500+ farmers use FarmSmart to optimize yields!</p>
                    <div id="authSection">
                        <h3 id="authTitle" class="text-2xl font-semibold mb-4 text-green-700">Login</h3>
                        <form id="authForm">
                            <div id="nameField" class="mb-4 hidden">
                                <input type="text" id="name" class="w-full p-2 border rounded-lg" placeholder="Name" required>
                            </div>
                            <div class="mb-4">
                                <input type="email" id="email" class="w-full p-2 border rounded-lg" placeholder="Email" required>
                            </div>
                            <div class="mb-4">
                                <input type="password" id="password" class="w-full p-2 border rounded-lg" placeholder="Password" required>
                            </div>
                            <button type="submit" id="authSubmit" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Login</button>
                        </form>
                        <p class="mt-4 text-gray-700">
                            <a id="toggleAuth" href="#" class="text-green-600 hover:underline">Register instead</a>
                        </p>
                        <div id="authError" class="text-red-500 mt-4 hidden"></div>
                        <div id="authLoading" class="text-center mt-4 hidden">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Farm Input -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="farm-input" role="tabpanel" aria-labelledby="farm-input-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Enter Farm Details</h3>
                <form id="farmForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700">Location</label>
                        <input type="text" id="location" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Land Size (acres)</label>
                        <input type="number" id="landSize" class="w-full p-2 border rounded-lg" step="0.1" min="0.1" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Water Available (L)</label>
                        <input type="number" id="waterAvailable" class="w-full p-2 border rounded-lg" step="100" min="0">
                    </div>
                    <div>
                        <label class="block text-gray-700">Start Date</label>
                        <input type="date" id="startDate" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Soil Input Method</label>
                        <select id="soilOption" class="w-full p-2 border rounded-lg" onchange="toggleSoilInput()">
                            <option value="manual">Manual Selection</option>
                            <option value="sensor">Sensor Input</option>
                        </select>
                    </div>
                    <div id="manualSoil">
                        <label class="block text-gray-700">Soil Type</label>
                        <select id="soilType" class="w-full p-2 border rounded-lg" required>
                            <option value="Coastal Alluvial">Coastal Alluvial</option>
                            <option value="Sandy Soil">Sandy Soil</option>
                            <option value="Loamy Soil">Loamy Soil</option>
                            <option value="Laterite Soil">Laterite Soil</option>
                            <option value="Red Sandy Loam - Fine Sandy Loam">Red Sandy Loam - Fine Sandy Loam</option>
                            <option value="Red Sandy Loam - Coarse Sandy Loam">Red Sandy Loam - Coarse Sandy Loam</option>
                            <option value="Red Sandy Loam - Gravelly Sandy Loam">Red Sandy Loam - Gravelly Sandy Loam</option>
                            <option value="Black Cotton Soil - Shallow Black Soil">Black Cotton Soil - Shallow Black Soil</option>
                            <option value="Black Cotton Soil - Medium Black Soil">Black Cotton Soil - Medium Black Soil</option>
                            <option value="Black Cotton Soil - Deep Black Soil">Black Cotton Soil - Deep Black Soil</option>
                        </select>
                    </div>
                    <div id="sensorSoil" class="hidden space-y-4">
                        <div>
                            <label class="block text-gray-700">R (0-255)</label>
                            <input type="number" id="r" class="w-full p-2 border rounded-lg" min="0" max="255">
                        </div>
                        <div>
                            <label class="block text-gray-700">G (0-255)</label>
                            <input type="number" id="g" class="w-full p-2 border rounded-lg" min="0" max="255">
                        </div>
                        <div>
                            <label class="block text-gray-700">B (0-255)</label>
                            <input type="number" id="b" class="w-full p-2 border rounded-lg" min="0" max="255">
                        </div>
                        <div>
                            <label class="block text-gray-700">pH (0-14)</label>
                            <input type="number" id="ph" class="w-full p-2 border rounded-lg" step="0.1" min="0" max="14">
                        </div>
                        <div>
                            <label class="block text-gray-700">EC (mS/cm)</label>
                            <input type="number" id="ec" class="w-full p-2 border rounded-lg" step="0.01" min="0">
                        </div>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Get Recommendations</button>
                </form>
                <div id="farmError" class="text-red-500 mt-4 hidden"></div>
                <div id="farmLoading" class="text-center mt-4 hidden">Loading...</div>
            </div>

            <!-- Crop Recommendations -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="recommendations" role="tabpanel" aria-labelledby="recommendations-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Crop Recommendations</h3>
                <p id="soilType" class="mb-4 text-gray-700"></p>
                <div id="recommendationsList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </div>

            <!-- Generate Schedule -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Generate Schedules for ${selectedCrop}</h3>
                <div class="space-y-4">
                    <button id="generateWaterSchedule" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Generate Water Schedule</button>
                    <div id="waterSchedule" class="mt-4 text-gray-700"></div>
                    <button id="generateNutrientSchedule" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Generate Nutrient Schedule</button>
                    <div id="nutrientSchedule" class="mt-4 text-gray-700"></div>
                </div>
            </div>

            <!-- Crop Details -->
            <div class="hidden p-6 rounded-lg shadow-md" id="crop-details" role="tabpanel" aria-labelledby="crop-details-tab">
                <h3 class="text-xl font-bold mb-4 text-white">Crop Details</h3>
                <div id="cropDetails" class="text-white space-y-4"></div>
            </div>

            <!-- Moisture Level -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="moisture" role="tabpanel" aria-labelledby="moisture-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Moisture Level</h3>
                <button id="checkMoistureLevel" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 mb-4">Check Moisture Level</button>
                <div id="moistureLevel" class="text-gray-700"></div>
                <p id="lastUpdated" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- Motor Status -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="motor-status" role="tabpanel" aria-labelledby="motor-status-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Motor Status</h3>
                <button id="checkMotorStatus" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 mb-4">Check Motor Status</button>
                <div id="motorStatus" class="text-gray-700"></div>
            </div>

            <!-- Notifications -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Notifications</h3>
                <div id="notificationsList" class="text-gray-700"></div>
            </div>

            <!-- Organic Pesticides -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="pesticides" role="tabpanel" aria-labelledby="pesticides-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Organic Pesticides</h3>
                <div id="pesticidesInfo" class="text-gray-700 space-y-6">
                    <div>
                        <h4 class="font-bold">1. Neem Oil Spray</h4>
                        <p><strong>Proportions:</strong> 1 liter water, 5 ml neem oil, 1 ml liquid soap (as emulsifier)</p>
                        <p><strong>Process:</strong> Mix neem oil with liquid soap in a small bowl to emulsify. Slowly add this mixture to 1 liter of water while stirring continuously. Pour into a spray bottle and shake well before use. Apply to affected plants every 7-10 days.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">2. Garlic Spray</h4>
                        <p><strong>Proportions:</strong> 10 garlic cloves, 1 liter water, 1 tsp mineral oil</p>
                        <p><strong>Process:</strong> Crush garlic cloves and soak in 1 liter of water for 24 hours. Strain the liquid, add mineral oil, and mix well. Pour into a spray bottle and apply to plants, focusing on pest-infested areas, every 5 days.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">3. Chili Pepper Spray</h4>
                        <p><strong>Proportions:</strong> 10-15 hot chili peppers, 1 liter water, 1 tsp soap</p>
                        <p><strong>Process:</strong> Blend chili peppers with water, strain to remove solids, and add soap to enhance adhesion. Pour into a spray bottle and apply to leaves, avoiding overuse to prevent plant damage, every 4-6 days.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">4. Tomato Leaf Spray</h4>
                        <p><strong>Proportions:</strong> 2 cups chopped tomato leaves, 1 liter water</p>
                        <p><strong>Process:</strong> Boil tomato leaves in water for 30 minutes, then cool and strain. Dilute with an equal amount of water and spray on plants affected by soft-bodied insects every week.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">5. Soap Spray</h4>
                        <p><strong>Proportions:</strong> 1 tbsp liquid soap, 1 liter water</p>
                        <p><strong>Process:</strong> Mix soap with water until fully dissolved. Pour into a spray bottle and apply to aphids or mites on plants, rinsing after 24 hours to avoid residue, every 5 days.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">6. Vinegar Spray</h4>
                        <p><strong>Proportions:</strong> 1 cup vinegar, 1 liter water</p>
                        <p><strong>Process:</strong> Combine vinegar and water, then pour into a spray bottle. Use on weeds or fungal growth, applying sparingly to avoid plant damage, every 10 days.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">7. Diatomaceous Earth</h4>
                        <p><strong>Proportions:</strong> 100g food-grade diatomaceous earth, 1 liter water (for slurry)</p>
                        <p><strong>Process:</strong> Mix diatomaceous earth with water to create a slurry, then sprinkle or spray on soil around plants to deter crawling insects. Reapply after rain, every 7-10 days.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">8. Mint Spray</h4>
                        <p><strong>Proportions:</strong> 1 cup fresh mint leaves, 1 liter water</p>
                        <p><strong>Process:</strong> Boil mint leaves in water for 20 minutes, cool, and strain. Dilute with equal water and spray on plants to repel ants and aphids, every 6 days.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">9. Citrus Peel Spray</h4>
                        <p><strong>Proportions:</strong> Peels of 3 citrus fruits, 1 liter water</p>
                        <p><strong>Process:</strong> Soak peels in water for 48 hours, strain, and pour into a spray bottle. Apply to plants to deter pests like whiteflies, every 8 days.</p>
                    </div>
                    <div>
                        <h4 class="font-bold">10. Tobacco Spray</h4>
                        <p><strong>Proportions:</strong> 1 cup tobacco leaves, 1 liter water</p>
                        <p><strong>Process:</strong> Soak tobacco leaves in water for 24 hours, strain, and dilute with equal water. Use sparingly on hardy plants to kill soft-bodied pests, every 10 days, with caution due to toxicity.</p>
                    </div>
                </div>
            </div>

            <!-- Crop Progress -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="progress" role="tabpanel" aria-labelledby="progress-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Crop Progress</h3>
                <div id="progressBar" class="mb-4"></div>
                <div id="currentStage" class="mb-4 text-gray-700"></div>
                <div id="stageDetails" class="text-gray-700 space-y-4"></div>
                <img id="stageImage" class="stage-image hidden" alt="Stage Image">
                <select id="updateStage" class="p-2 border rounded-lg mb-4">
                    <option value="Preparation of soil">Preparation of soil</option>
                    <option value="Sowing">Sowing</option>
                    <option value="Adding fertilizers and manures">Adding fertilizers and manures</option>
                    <option value="Irrigation">Irrigation</option>
                    <option value="Protection from weeds or pests">Protection from weeds or pests</option>
                    <option value="Harvesting">Harvesting</option>
                    <option value="Storage of the yield">Storage of the yield</option>
                </select>
                <button id="updateStageBtn" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Update Stage</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
    <script>
        let farmerId = null;
        let selectedCrop = null;
        let soilType = null;
        let farmData = null;
        let manualStage = null; // Store manually selected stage

        // Toggle auth form
        const toggleAuth = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('authTitle');
        const authSubmit = document.getElementById('authSubmit');
        toggleAuth.addEventListener('click', (e) => {
            e.preventDefault();
            const isLogin = authTitle.textContent === 'Login';
            authTitle.textContent = isLogin ? 'Register' : 'Login';
            toggleAuth.textContent = isLogin ? 'Login instead' : 'Register instead';
            document.getElementById('nameField').classList.toggle('hidden', !isLogin);
            authSubmit.textContent = isLogin ? 'Register' : 'Login';
        });

        // Tab switching function
        function switchTab(tabId) {
            console.log(`Attempting to switch to tab: ${tabId}`);
            try {
                const tabContent = document.querySelectorAll('#tab-content > div');
                if (!tabContent.length) throw new Error('No tab content found');
                tabContent.forEach(div => div.classList.add('hidden'));

                const navLinks = document.querySelectorAll('nav a[role="tab"]');
                if (!navLinks.length) throw new Error('No navigation links found');
                navLinks.forEach(a => {
                    a.classList.remove('active');
                    a.setAttribute('aria-selected', 'false');
                });

                const targetTab = document.getElementById(tabId);
                if (!targetTab) throw new Error(`Tab content with id "${tabId}" not found`);
                targetTab.classList.remove('hidden');

                const targetTabLink = document.getElementById(`${tabId}-tab`);
                if (!targetTabLink) throw new Error(`Tab link with id "${tabId}-tab" not found`);
                targetTabLink.classList.add('active');
                targetTabLink.setAttribute('aria-selected', 'true');
                targetTabLink.focus();
                console.log(`Successfully switched to tab: ${tabId}`);
            } catch (err) {
                console.error('Error in switchTab:', err.message);
            }
        }

        function setupTabNavigation() {
            console.log('Setting up tab navigation listeners');
            const navLinks = document.querySelectorAll('nav a[role="tab"]');
            if (!navLinks.length) {
                console.warn('No navigation links with role="tab" found');
                return;
            }

            navLinks.forEach(a => {
                a.removeEventListener('click', handleTabClick);
                a.removeEventListener('keydown', handleTabKeydown);

                a.addEventListener('click', handleTabClick);
                a.addEventListener('keydown', handleTabKeydown);
            });
        }

        function handleTabClick(e) {
            e.preventDefault();
            const tabId = e.currentTarget.id.replace('-tab', '');
            console.log(`Tab clicked: ${tabId}`);
            switchTab(tabId);
        }

        function handleTabKeydown(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const tabId = e.currentTarget.id.replace('-tab', '');
                console.log(`Tab activated via keyboard: ${tabId}`);
                switchTab(tabId);
            }
        }

        // Handle auth form submission
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const isLogin = authTitle.textContent === 'Login';
            const endpoint = isLogin ? '/api/login' : '/api/register';
            const data = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            if (!isLogin) {
                data.name = document.getElementById('name').value;
            }

            const authError = document.getElementById('authError');
            const authLoading = document.getElementById('authLoading');
            authError.classList.add('hidden');
            authLoading.classList.remove('hidden');

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                authLoading.classList.add('hidden');

                if (!response.ok) {
                    authError.textContent = result.error || 'Authentication failed';
                    authError.classList.remove('hidden');
                    return;
                }

                if (isLogin) {
                    farmerId = result.farmer_id;
                    switchTab('farm-input');
                    document.getElementById('login').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.querySelectorAll('.navbar-tabs a').forEach(a => a.classList.remove('hidden'));
                    setupTabNavigation();
                } else {
                    authTitle.textContent = 'Login';
                    toggleAuth.textContent = 'Register instead';
                    document.getElementById('nameField').classList.add('hidden');
                    authSubmit.textContent = 'Login';
                    authError.textContent = result.message;
                    authError.classList.remove('text-red-500');
                    authError.classList.add('text-green-500');
                    authError.classList.remove('hidden');
                }
            } catch (err) {
                authLoading.classList.add('hidden');
                authError.textContent = 'Network error occurred';
                authError.classList.remove('hidden');
            }
        });

        // Toggle soil input
        function toggleSoilInput() {
            const soilOption = document.getElementById('soilOption').value;
            document.getElementById('manualSoil').classList.toggle('hidden', soilOption !== 'manual');
            document.getElementById('sensorSoil').classList.toggle('hidden', soilOption !== 'sensor');
            document.getElementById('soilType').required = soilOption === 'manual';
            ['r', 'g', 'b', 'ph', 'ec'].forEach(id => {
                document.getElementById(id).required = soilOption === 'sensor';
            });
        }

        // Handle farm form submission
        document.getElementById('farmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const farmError = document.getElementById('farmError');
            const farmLoading = document.getElementById('farmLoading');
            farmError.classList.add('hidden');
            farmLoading.classList.remove('hidden');

            if (!farmerId) {
                farmError.textContent = 'Please login to submit farm details';
                farmError.classList.remove('hidden');
                farmLoading.classList.add('hidden');
                return;
            }

            farmData = {
                farmer_id: farmerId,
                location: document.getElementById('location').value,
                land_size: parseFloat(document.getElementById('landSize').value),
                soil_option: document.getElementById('soilOption').value,
                start_date: document.getElementById('startDate').value,
                water_available: parseFloat(document.getElementById('waterAvailable').value) || 0
            };

            if (farmData.soil_option === 'manual') {
                farmData.soil_type = document.getElementById('soilType').value;
            } else {
                farmData.r = parseInt(document.getElementById('r').value) || 0;
                farmData.g = parseInt(document.getElementById('g').value) || 0;
                farmData.b = parseInt(document.getElementById('b').value) || 0;
                farmData.ph = parseFloat(document.getElementById('ph').value) || 0;
                farmData.ec = parseFloat(document.getElementById('ec').value) || 0;
            }

            try {
                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(farmData)
                });
                const result = await response.json();
                farmLoading.classList.add('hidden');

                if (!response.ok) {
                    farmError.textContent = result.error || 'Failed to get recommendations';
                    farmError.classList.remove('hidden');
                    return;
                }

                soilType = result.soil_type;
                document.getElementById('soilType').textContent = `Soil Type: ${soilType}`;
                const recommendationsList = document.getElementById('recommendationsList');
                // Filter out wheat and limit to 3 vegetable recommendations
                const filteredRecommendations = [
                    { crop: 'brinjal', image_url: 'DWylossWLPk7YifYkn1N1LE9YsSY9gHtQ3moGO1WLFimuOXRT7DX1OWyPosQ0WLFvjJ2WmF5rlavcsWKn2GCuK8WLEBD/9k=', nutrients: '50 kg/acre', water_requirement: '300 L/acre', cost: '$200', yield: '2000 kg/acre', market_trend: 'Stable' },
                    { crop: 'tomato', image_url: 'dmdLUsg6pUqsH8QQdUIthD1BA1CnYLepZzv0WwW9QyTalRsFyuOmrUemJlYVmtRekVpWg8kheNTYJiW0De2jkELQdSplN44IhFIbUlW1uwVOyty7l2Eg0V1wkeiP3lL6yyNVZC9Qq/VFxsNSmKrAqVgBPUa+SfGAl2lBqbo9iEytOxOzEALmsFadg3dP3bbAJkY4RnTnueRDiLXON76pscIU0cipDYXUNnH/2Q==', nutrients: '60 kg/acre', water_requirement: '400 L/acre', cost: '$250', yield: '2500 kg/acre', market_trend: 'Rising' },
                    { crop: 'okra', image_url: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQKf_ZaPEZUSeG74J4IQfiCAcEnWclp13LxDGAHKK519i3JpYSArxyjDQXGmafVOxOOxu4&usqp=CAU', nutrients: '45 kg/acre', water_requirement: '350 L/acre', cost: '$180', yield: '1800 kg/acre', market_trend: 'Stable' }
                ];
                recommendationsList.innerHTML = filteredRecommendations.map(r => `
                    <div class="crop-card p-4 rounded-lg flex flex-col items-center bg-white">
                        <img src="${r.image_url}" alt="${r.crop}" class="crop-image mb-2" onerror="this.src='https://via.placeholder.com/100';">
                        <h4 class="font-bold text-lg text-green-800">${r.crop}</h4>
                        <p class="text-gray-600">Nutrients: ${r.nutrients} kg/acre</p>
                        <p class="text-gray-600">Water: ${r.water_requirement} L/acre</p>
                        <p class="text-gray-600">Cost: ${r.cost}</p>
                        <p class="text-gray-600">Yield: ${r.yield}</p>
                        <p class="text-gray-600">Market Trend: ${r.market_trend}</p>
                        <button class="select-crop bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 mt-2 w-full" data-crop="${r.crop}">Select</button>
                    </div>
                `).join('');

                document.getElementById('recommendations-tab').classList.remove('hidden');
                switchTab('recommendations');
                setupTabNavigation();
                // Add event listener specifically for the recommendations tab
                const recommendationsTab = document.getElementById('recommendations');
                recommendationsTab.addEventListener('click', handleCropSelection);
            } catch (err) {
                farmLoading.classList.add('hidden');
                farmError.textContent = 'Failed to connect to server: ' + err.message;
                farmError.classList.remove('hidden');
            }
        });

        // Handle crop selection
        function handleCropSelection(e) {
            const button = e.target.closest('.select-crop');
            if (button) {
                e.preventDefault(); // Prevent any default behavior
                const crop = button.getAttribute('data-crop');
                console.log('Crop button clicked, crop:', crop);
                if (!crop) {
                    console.error('No data-crop attribute found on button:', button);
                    return;
                }

                selectedCrop = crop;
                console.log('Selected crop set to:', selectedCrop);

                // Enable relevant tabs
                document.getElementById('schedule-tab').classList.remove('hidden');
                document.getElementById('moisture-tab').classList.remove('hidden');
                document.getElementById('crop-details-tab').classList.remove('hidden');

                // Fetch crop details
                fetch(`/api/crop_details?crop=${selectedCrop}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch crop details');
                        return response.json();
                    })
                    .then(result => {
                        document.getElementById('crop-details').style.backgroundImage = `url('${result.image_url || 'https://via.placeholder.com/400'}')`;
                        document.getElementById('cropDetails').innerHTML = `
                            <div class="p-4 rounded-lg bg-black bg-opacity-50">
                                <h4 class="font-bold text-lg">Scientific Name</h4>
                                <p>${result.details["Scientific Name"] || 'N/A'}</p>
                                <h4 class="font-bold text-lg mt-4">Growth Conditions</h4>
                                <p>${result.details["Growth Conditions"] || 'N/A'}</p>
                                <h4 class="font-bold text-lg mt-4">Soil Requirements</h4>
                                <p>${result.details["Soil Requirements"] || 'N/A'}</p>
                                <h4 class="font-bold text-lg mt-4">Water Needs</h4>
                                <p>${result.details["Water Needs"] || 'N/A'}</p>
                                <h4 class="font-bold text-lg mt-4">Care Tips</h4>
                                <p>${result.details["Care Tips"] || 'N/A'}</p>
                                <h4 class="font-bold text-lg mt-4">Pests and Diseases</h4>
                                <p>${result.details["Pests and Diseases"] || 'N/A'}</p>
                                <h4 class="font-bold text-lg mt-4">Harvest Time</h4>
                                <p>${result.details["Harvest Time"] || 'N/A'}</p>
                                <h4 class="font-bold text-lg mt-4">Yield Potential</h4>
                                <p>${result.details["Yield Potential"] || 'N/A'}</p>
                            </div>
                        `;
                    })
                    .catch(err => {
                        console.error('Error fetching crop details:', err);
                        document.getElementById('cropDetails').innerHTML = `<p class="text-red-500">Network error: ${err.message}</p>`;
                    });

                switchTab('schedule');
                setupTabNavigation();
                updateProgress();
            }
        }

        // Generate water schedule
        document.getElementById('generateWaterSchedule').addEventListener('click', async () => {
            if (!selectedCrop) {
                alert('Please select a crop first');
                return;
            }
            try {
                const response = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        farmer_id: farmerId,
                        crop: selectedCrop,
                        soil_type: soilType,
                        land_size: farmData.land_size,
                        start_date: farmData.start_date,
                        water_available: farmData.water_available
                    })
                });
                const result = await response.json();
                if (!response.ok) {
                    alert('Failed to generate water schedule: ' + result.error);
                    return;
                }
                document.getElementById('waterSchedule').innerHTML = `
                    <table class="w-full border-collapse border">
                        <thead>
                            <tr class="bg-green-100">
                                <th class="border p-2 text-green-800">Day</th>
                                <th class="border p-2 text-green-800">Time</th>
                                <th class="border p-2 text-green-800">Water Quantity (L)</th>
                                <th class="border p-2 text-green-800">Method</th>
                                <th class="border p-2 text-green-800">Speed</th>
                                <th class="border p-2 text-green-800">Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.water_schedule.map(s => `
                                <tr>
                                    <td class="border p-2">${s.day}</td>
                                    <td class="border p-2">${s.time}</td>
                                    <td class="border p-2">${s.water_quantity}</td>
                                    <td class="border p-2">${s.method}</td>
                                    <td class="border p-2">${s.speed}</td>
                                    <td class="border p-2">${s.duration}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                alert('Failed to connect to server: ' + err.message);
            }
        });

        // Generate nutrient schedule
        document.getElementById('generateNutrientSchedule').addEventListener('click', async () => {
            if (!selectedCrop) {
                alert('Please select a crop first');
                return;
            }
            try {
                const response = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        farmer_id: farmerId,
                        crop: selectedCrop,
                        soil_type: soilType,
                        land_size: farmData.land_size,
                        start_date: farmData.start_date,
                        water_available: farmData.water_available
                    })
                });
                const result = await response.json();
                if (!response.ok) {
                    alert('Failed to generate nutrient schedule: ' + result.error);
                    return;
                }
                document.getElementById('nutrientSchedule').innerHTML = `
                    <table class="w-full border-collapse border">
                        <thead>
                            <tr class="bg-green-100">
                                <th class="border p-2 text-green-800">Week Start</th>
                                <th class="border p-2 text-green-800">Nutrient Quantity (kg)</th>
                                <th class="border p-2 text-green-800">Type</th>
                                <th class="border p-2 text-green-800">Application Method</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.nutrient_schedule.map(s => `
                                <tr>
                                    <td class="border p-2">${s.week_start}</td>
                                    <td class="border p-2">${s.nutrient_quantity}</td>
                                    <td class="border p-2">${s.type}</td>
                                    <td class="border p-2">${s.application_method}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                alert('Failed to connect to server: ' + err.message);
            }
        });

        // Check moisture level from ThingSpeak
        document.getElementById('checkMoistureLevel').addEventListener('click', async () => {
            if (!farmerId) return;
            try {
                const response = await fetch(`/api/thingspeak_moisture?farmer_id=${farmerId}`);
                const result = await response.json();
                if (!response.ok || !result.last_value) {
                    document.getElementById('moistureLevel').innerHTML = `
                        <p class="text-gray-700"><strong>Last Moisture Level:</strong> N/A (Data not found)</p>
                        <p class="text-gray-700"><strong>Last Updated:</strong> N/A</p>
                    `;
                } else {
                    const lastValue = result.last_value;
                    const lastUpdated = result.last_updated;
                    document.getElementById('moistureLevel').innerHTML = `
                        <p class="text-gray-700"><strong>Last Moisture Level:</strong> ${lastValue}%</p>
                        <p class="text-gray-700"><strong>Last Updated:</strong> ${lastUpdated}</p>
                    `;
                }
                document.getElementById('lastUpdated').textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
            } catch (err) {
                document.getElementById('moistureLevel').innerHTML = `
                    <p class="text-red-500">Network error: ${err.message}</p>
                `;
            }
        });

        // Define updateMoisture function
        async function updateMoisture() {
            if (!farmerId) return;
            try {
                const response = await fetch(`/api/thingspeak_moisture?farmer_id=${farmerId}`);
                const result = await response.json();
                if (!response.ok || !result.last_value) {
                    document.getElementById('moistureLevel').innerHTML = `
                        <p class="text-gray-700"><strong>Last Moisture Level:</strong> N/A (Data not found)</p>
                        <p class="text-gray-700"><strong>Last Updated:</strong> N/A</p>
                    `;
                } else {
                    const lastValue = result.last_value;
                    const lastUpdated = result.last_updated;
                    document.getElementById('moistureLevel').innerHTML = `
                        <p class="text-gray-700"><strong>Last Moisture Level:</strong> ${lastValue}%</p>
                        <p class="text-gray-700"><strong>Last Updated:</strong> ${lastUpdated}</p>
                    `;
                }
                document.getElementById('lastUpdated').textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
            } catch (err) {
                console.error('Error updating moisture:', err.message);
            }
        }

        setInterval(updateMoisture, 10 * 60 * 1000);

        // Check motor status
        document.getElementById('checkMotorStatus').addEventListener('click', async () => {
            if (!farmerId) return;
            try {
                const response = await fetch(`/api/monitor?farmer_id=${farmerId}`);
                const result = await response.json();
                if (!response.ok || !result.moisture) {
                    document.getElementById('motorStatus').innerHTML = `
                        <p class="text-gray-700"><strong>Moisture Level:</strong> N/A (Data not found)</p>
                        <p class="text-gray-700"><strong>Motor Status:</strong> N/A</p>
                        <p class="text-gray-700"><strong>Water Supplied:</strong> N/A L</p>
                    `;
                } else {
                    document.getElementById('motorStatus').innerHTML = `
                        <p class="text-gray-700"><strong>Moisture Level:</strong> ${result.moisture}</p>
                        <p class="text-gray-700"><strong>Motor Status:</strong> ${result.motor_status}</p>
                        <p class="text-gray-700"><strong>Water Supplied:</strong> ${result.water_supplied} L</p>
                    `;
                }

                document.getElementById('notificationsList').innerHTML = result.notifications.map(n => `
                    <div class="p-4 mb-2 rounded-lg ${n.type === 'warning' ? 'bg-yellow-100' : 'bg-blue-100'}">
                        <p class="text-gray-700">${n.message}</p>
                    </div>
                `).join('');
                updateProgress();
            } catch (err) {
                alert('Monitoring network error: ' + err.message);
            }
        });

        // Update crop stage
        document.getElementById('updateStageBtn').addEventListener('click', async () => {
            if (!selectedCrop) {
                alert('Please select a crop first');
                return;
            }
            const newStage = document.getElementById('updateStage').value;
            manualStage = newStage; // Store the manually selected stage
            try {
                const response = await fetch('/api/update_stage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        farmer_id: farmerId,
                        stage: newStage,
                        selected_crop: selectedCrop
                    })
                });
                const result = await response.json();
                if (!response.ok) {
                    alert('Failed to update stage: ' + result.error);
                    return;
                }
                document.getElementById('progressBar').innerHTML = `
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-green-600 h-4 rounded-full" style="width: ${result.progress}%"></div>
                    </div>
                `;
                document.getElementById('currentStage').textContent = `Current Stage: ${result.stage}`;
                updateProgress(); // Refresh stage details using the manual stage
            } catch (err) {
                alert('Failed to update stage: ' + err.message);
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            farmerId = null;
            selectedCrop = null;
            soilType = null;
            farmData = null;
            manualStage = null; // Reset manual stage on logout
            document.getElementById('farm-input').classList.add('hidden');
            document.getElementById('login').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('authForm').reset();
            authTitle.textContent = 'Login';
            toggleAuth.textContent = 'Register instead';
            authSubmit.textContent = 'Login';
            document.getElementById('nameField').classList.add('hidden');
            document.querySelectorAll('.navbar-tabs a').forEach(a => a.classList.add('hidden'));
            switchTab('login');
            setupTabNavigation();
        });

        // Update crop progress based on start date or manual selection
        function updateProgress() {
            if (!selectedCrop) return;

            let stage, progress, details, imageUrl;
            let daysElapsed = 0;

            // If a manual stage is selected, use it; otherwise, calculate based on days elapsed
            if (manualStage) {
                stage = manualStage;
            } else if (farmData?.start_date) {
                const start = new Date(farmData.start_date);
                const now = new Date();
                daysElapsed = Math.floor((now - start) / (1000 * 60 * 60 * 24));
                if (daysElapsed < 7) {
                    stage = 'Preparation of soil';
                } else if (daysElapsed < 14) {
                    stage = 'Sowing';
                } else if (daysElapsed < 30) {
                    stage = 'Adding fertilizers and manures';
                } else if (daysElapsed < 60) {
                    stage = 'Irrigation';
                } else if (daysElapsed < 90) {
                    stage = 'Protection from weeds or pests';
                } else if (daysElapsed < 120) {
                    stage = 'Harvesting';
                } else {
                    stage = 'Storage of the yield';
                }
            } else {
                stage = 'Preparation of soil'; // Default stage if no start date
            }

            // Define progress and details based on the stage
            if (stage === 'Preparation of soil') {
                progress = 14;
                details = `
                    <h4 class="font-bold">Precautions:</h4>
                    <p>Ensure proper drainage to avoid waterlogging. Avoid working on wet soil to prevent compaction.</p>
                    <h4 class="font-bold">Measures:</h4>
                    <p>Test soil pH and nutrients. Add organic matter like compost if needed.</p>
                    <h4 class="font-bold">Steps:</h4>
                    <ol class="list-decimal pl-5">
                        <li>Clear weeds and debris from the field.</li>
                        <li>Plow or till the soil to a depth of 6-8 inches.</li>
                        <li>Level the land for even water distribution.</li>
                    </ol>
                `;
                imageUrl = 'data:image/jpeg;base64,/9j/ibVu4gKU5SGQVSHKbbrgEGQCdxJxR8Fw9oBKrekHSe0y5BUYIJDkE5L1KlSiDzbJnUZ5Y+VSpUrNulP/9k=';
            } else if (stage === 'Sowing') {
                progress = 28;
                details = `
                    <h4 class="font-bold">Precautions:</h4>
                    <p>Use clean seeds to prevent disease spread. Sow at the recommended depth and spacing.</p>
                    <h4 class="font-bold">Measures:</h4>
                    <p>Check weather for optimal planting conditions. Ensure soil moisture is adequate.</p>
                    <h4 class="font-bold">Steps:</h4>
                    <ol class="list-decimal pl-5">
                        <li>Mark rows or beds for planting.</li>
                        <li>Place seeds at the correct depth and cover with soil.</li>
                        <li>Water gently to settle the seeds.</li>
                    </ol>
                `;
                imageUrl = 'dTQpBNQBRlcVXIZreYiRIMk1YmRmylSwoVcZkhnILZVDZtI7OKcoUsKykAoSKFVg5VmOh135RIka0m1RhnqpagToQCw6gxIkSJtrT/9k=';
            } else if (stage === 'Adding fertilizers and manures') {
                progress = 43;
                details = `
                    <h4 class="font-bold">Precautions:</h4>
                    <p>Avoid over-fertilization to prevent nutrient burn. Use organic options to maintain soil health.</p>
                    <h4 class="font-bold">Measures:</h4>
                    <p>Test soil for deficiencies. Apply compost or manure evenly.</p>
                    <h4 class="font-bold">Steps:</h4>
                    <ol class="list-decimal pl-5">
                        <li>Spread manure or compost over the field.</li>
                        <li>Incorporate into the topsoil with light tilling.</li>
                        <li>Water the field lightly after application.</li>
                    </ol>
                `;
                imageUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRsvrlFNU4CZdtVjzG6UnVyRCi2EQZwbSVigA&s';
            } else if (stage === 'Irrigation') {
                progress = 57;
                details = `
                    <h4 class="font-bold">Precautions:</h4>
                    <p>Avoid overwatering to prevent root rot. Monitor soil moisture regularly.</p>
                    <h4 class="font-bold">Measures:</h4>
                    <p>Use drip irrigation for efficiency. Check water quality.</p>
                    <h4 class="font-bold">Steps:</h4>
                    <ol class="list-decimal pl-5">
                        <li>Schedule irrigation based on crop needs.</li>
                        <li>Apply water evenly across the field.</li>
                        <li>Check for drainage issues post-irrigation.</li>
                    </ol>
                `;
                imageUrl = 'data:image/jpeg;base64bHBOXJT8VZn9lrCkGLSJk7+MWdIfWL847HY8jX44puS8kZIpS4HiUwBtjsdjseQUf/9k=';
            } else if (stage === 'Protection from weeds or pests') {
                progress = 71;
                details = `
                    <h4 class="font-bold">Precautions:</h4>
                    <p>Use organic pesticides to avoid chemical residue. Monitor pest levels regularly.</p>
                    <h4 class="font-bold">Measures:</h4>
                    <p>Remove weeds manually or with mulch. Apply neem oil spray if pests are detected.</p>
                    <h4 class="font-bold">Steps:</h4>
                    <ol class="list-decimal pl-5">
                        <li>Inspect plants for pests and weeds.</li>
                        <li>Apply organic pest control as needed.</li>
                        <li>Clear weed growth around crops.</li>
                    </ol>
                `;
                imageUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQXbaRqa0LHgDuD-SJ-uu_XN90pS9AXPL4wyg&s';
            } else if (stage === 'Harvesting') {
                progress = 86;
                details = `
                    <h4 class="font-bold">Precautions:</h4>
                    <p>Harvest at the right maturity to ensure quality. Use clean tools to avoid contamination.</p>
                    <h4 class="font-bold">Measures:</h4>
                    <p>Check crop readiness by visual inspection. Plan for timely transport.</p>
                    <h4 class="font-bold">Steps:</h4>
                    <ol class="list-decimal pl-5">
                        <li>Assess crop maturity.</li>
                        <li>Cut or pick crops carefully.</li>
                        <li>Collect and sort the harvest.</li>
                    </ol>
                `;
                imageUrl = 'data:image/jpeg;base64,/9dl6OSQCpYSSHalRzfIUB9BEiRImxUf/2Q==';
            } else if (stage === 'Storage of the yield') {
                progress = 100;
                details = `
                    <h4 class="font-bold">Precautions:</h4>
                    <p>Store in a cool, dry place to prevent spoilage. Check for pests in storage.</p>
                    <h4 class="font-bold">Measures:</h4>
                    <p>Use ventilated containers. Monitor temperature and humidity.</p>
                    <h4 class="font-bold">Steps:</h4>
                    <ol class="list-decimal pl-5">
                        <li>Clean and dry the yield.</li>
                        <li>Pack in suitable containers.</li>
                        <li>Store in a controlled environment.</li>
                    </ol>
                `;
                imageUrl = 'data:image/jpeg;base64,/9j/6GlSpdTToDUqVKqMz//Z';
            }

            document.getElementById('progressBar').innerHTML = `
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="bg-green-600 h-4 rounded-full" style="width: ${progress}%"></div>
                </div>
            `;
            document.getElementById('currentStage').textContent = `Current Stage: ${stage}${manualStage ? '' : ' (' + daysElapsed + ' days elapsed)'}`;
            document.getElementById('stageDetails').innerHTML = details;
            const stageImage = document.getElementById('stageImage');
            stageImage.src = imageUrl;
            stageImage.classList.remove('hidden');
        }

        // Initial load
        window.onload = () => {
            const farmForm = document.getElementById('farmForm');
            if (!farmForm) console.error('Farm form not found');
            else console.log('Farm form loaded successfully');
            setupTabNavigation();
        };
    </script>
</body>
</html>
