<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmSmart - Precision Agriculture</title>
    <link rel="icon" type="image/png" href="https://optcms.s3.ca-central-1.amazonaws.com/www.indiavsdisinformation.com/2023/202302/20230226-wsfl20230227131as.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: url('https://farmsmart-5ziz.onrender.com') no-repeat center center fixed; /* Indian rice field */
            background-size: cover;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }
        .hidden {
            display: none;
        }
        .crop-card {
            transition: transform 0.3s;
            border: 1px solid #e5e7eb;
        }
        .crop-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .crop-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .navbar-tabs {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Navbar -->
    <nav class="bg-green-700 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">FarmSmart</h1>
            <div class="navbar-tabs">
                <a href="#" id="farm-input-tab" class="text-white hover:text-green-200 hidden">Farm Input</a>
                <a href="#" id="recommendations-tab" class="text-white hover:text-green-200 hidden">Recommendations</a>
                <a href="#" id="schedule-tab" class="text-white hover:text-green-200 hidden">Generate Schedule</a>
                <a href="#" id="crop-details-tab" class="text-white hover:text-green-200 hidden">Crop Details</a>
                <a href="#" id="moisture-tab" class="text-white hover:text-green-200 hidden">Moisture Level</a>
                <a href="#" id="motor-status-tab" class="text-white hover:text-green-200 hidden">Motor Status</a>
                <a href="#" id="notifications-tab" class="text-white hover:text-green-200 hidden">Notifications</a>
                <a href="#" id="pesticides-tab" class="text-white hover:text-green-200 hidden">Organic Pesticides</a>
                <a href="#" id="progress-tab" class="text-white hover:text-green-200 hidden">Crop Progress</a>
                <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 px-4 py-2 rounded">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Tab Content -->
    <div class="container mx-auto p-6">
        <div id="tab-content">
            <!-- Login Page -->
            <div id="login" class="min-h-screen flex items-center justify-center" role="tabpanel" aria-labelledby="farm-input-tab">
                <div class="login-container p-8 rounded-lg shadow-lg max-w-md text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-4">Welcome to FarmSmart</h2>
                    <p class="text-gray-600 mb-6">use FarmSmart to optimize yields!</p>
                    <div id="authSection">
                        <h3 id="authTitle" class="text-2xl font-semibold mb-4 text-green-700">Login</h3>
                        <form id="authForm">
                            <div id="nameField" class="mb-4 hidden">
                                <input type="text" id="name" class="w-full p-2 border rounded-lg" placeholder="Name" required>
                            </div>
                            <div class="mb-4">
                                <input type="email" id="email" class="w-full p-2 border rounded-lg" placeholder="Email" required>
                            </div>
                            <div class="mb-4">
                                <input type="password" id="password" class="w-full p-2 border rounded-lg" placeholder="Password" required>
                            </div>
                            <button type="submit" id="authSubmit" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Login</button>
                        </form>
                        <p class="mt-4 text-gray-700">
                            <a id="toggleAuth" href="#" class="text-green-600 hover:underline">Register instead</a>
                        </p>
                        <div id="authError" class="text-red-500 mt-4 hidden"></div>
                        <div id="authLoading" class="text-center mt-4 hidden">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Farm Input -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="farm-input" role="tabpanel" aria-labelledby="farm-input-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Enter Farm Details</h3>
                <form id="farmForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700">Location</label>
                        <input type="text" id="location" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Land Size (acres)</label>
                        <input type="number" id="landSize" class="w-full p-2 border rounded-lg" step="0.1" min="0.1" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Water Available (L)</label>
                        <input type="number" id="waterAvailable" class="w-full p-2 border rounded-lg" step="100" min="0">
                    </div>
                    <div>
                        <label class="block text-gray-700">Start Date</label>
                        <input type="date" id="startDate" class="w-full p-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-gray-700">Soil Input Method</label>
                        <select id="soilOption" class="w-full p-2 border rounded-lg" onchange="toggleSoilInput()">
                            <option value="manual">Manual Selection</option>
                            <option value="sensor">Sensor Input</option>
                        </select>
                    </div>
                    <div id="manualSoil">
                        <label class="block text-gray-700">Soil Type</label>
                        <select id="soilType" class="w-full p-2 border rounded-lg" required>
                            <option value="Coastal Alluvial">Coastal Alluvial</option>
                            <option value="Sandy Soil">Sandy Soil</option>
                            <option value="Loamy Soil">Loamy Soil</option>
                            <option value="Laterite Soil">Laterite Soil</option>
                            <option value="Red Sandy Loam - Fine Sandy Loam">Red Sandy Loam - Fine Sandy Loam</option>
                            <option value="Red Sandy Loam - Coarse Sandy Loam">Red Sandy Loam - Coarse Sandy Loam</option>
                            <option value="Red Sandy Loam - Gravelly Sandy Loam">Red Sandy Loam - Gravelly Sandy Loam</option>
                            <option value="Black Cotton Soil - Shallow Black Soil">Black Cotton Soil - Shallow Black Soil</option>
                            <option value="Black Cotton Soil - Medium Black Soil">Black Cotton Soil - Medium Black Soil</option>
                            <option value="Black Cotton Soil - Deep Black Soil">Black Cotton Soil - Deep Black Soil</option>
                        </select>
                    </div>
                    <div id="sensorSoil" class="hidden space-y-4">
                        <div>
                            <label class="block text-gray-700">R (0-255)</label>
                            <input type="number" id="r" class="w-full p-2 border rounded-lg" min="0" max="255">
                        </div>
                        <div>
                            <label class="block text-gray-700">G (0-255)</label>
                            <input type="number" id="g" class="w-full p-2 border rounded-lg" min="0" max="255">
                        </div>
                        <div>
                            <label class="block text-gray-700">B (0-255)</label>
                            <input type="number" id="b" class="w-full p-2 border rounded-lg" min="0" max="255">
                        </div>
                        <div>
                            <label class="block text-gray-700">pH (0-14)</label>
                            <input type="number" id="ph" class="w-full p-2 border rounded-lg" step="0.1" min="0" max="14">
                        </div>
                        <div>
                            <label class="block text-gray-700">EC (mS/cm)</label>
                            <input type="number" id="ec" class="w-full p-2 border rounded-lg" step="0.01" min="0">
                        </div>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Get Recommendations</button>
                </form>
                <div id="farmError" class="text-red-500 mt-4 hidden"></div>
                <div id="farmLoading" class="text-center mt-4 hidden">Loading...</div>
            </div>

            <!-- Crop Recommendations -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="recommendations" role="tabpanel" aria-labelledby="recommendations-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Crop Recommendations</h3>
                <p id="soilType" class="mb-4 text-gray-700"></p>
                <div id="recommendationsList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </div>

            <!-- Generate Schedule -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Generate Schedules for ${selectedCrop}</h3>
                <div class="space-y-4">
                    <button id="generateWaterSchedule" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Generate Water Schedule</button>
                    <div id="waterSchedule" class="mt-4 text-gray-700"></div>
                    <button id="generateNutrientSchedule" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Generate Nutrient Schedule</button>
                    <div id="nutrientSchedule" class="mt-4 text-gray-700"></div>
                </div>
            </div>

            <!-- Crop Details -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="crop-details" role="tabpanel" aria-labelledby="crop-details-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Crop Details</h3>
                <div id="cropDetails" class="text-gray-700"></div>
            </div>

            <!-- Moisture Level -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="moisture" role="tabpanel" aria-labelledby="moisture-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Moisture Level</h3>
                <div id="moistureLevel" class="text-gray-700"></div>
                <p id="lastUpdated" class="text-sm text-gray-500 mt-2"></p>
            </div>

            <!-- Motor Status -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="motor-status" role="tabpanel" aria-labelledby="motor-status-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Motor Status</h3>
                <button id="checkMotorStatus" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 mb-4">Check Motor Status</button>
                <div id="motorStatus" class="text-gray-700"></div>
            </div>

            <!-- Notifications -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Notifications</h3>
                <div id="notificationsList" class="text-gray-700"></div>
            </div>

            <!-- Organic Pesticides -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="pesticides" role="tabpanel" aria-labelledby="pesticides-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Organic Pesticides</h3>
                <div id="pesticidesInfo" class="text-gray-700"></div>
            </div>

            <!-- Crop Progress -->
            <div class="hidden p-6 bg-white rounded-lg shadow-md" id="progress" role="tabpanel" aria-labelledby="progress-tab">
                <h3 class="text-xl font-bold mb-4 text-green-800">Crop Progress</h3>
                <div id="progressBar" class="mb-4"></div>
                <div id="currentStage" class="mb-4 text-gray-700"></div>
                <select id="updateStage" class="p-2 border rounded-lg mb-4">
                    <option value="Seedling">Seedling</option>
                    <option value="Vegetative Growth">Vegetative Growth</option>
                    <option value="Flowering">Flowering</option>
                    <option value="Fruiting">Fruiting</option>
                    <option value="Harvesting">Harvesting</option>
                </select>
                <button id="updateStageBtn" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Update Stage</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
    <script>
        let farmerId = null;
        let selectedCrop = null;
        let soilType = null;
        let farmData = null;

        // Toggle auth form
        const toggleAuth = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('authTitle');
        toggleAuth.addEventListener('click', (e) => {
            e.preventDefault();
            const isLogin = authTitle.textContent === 'Login';
            authTitle.textContent = isLogin ? 'Register' : 'Login';
            toggleAuth.textContent = isLogin ? 'Login instead' : 'Register instead';
            document.getElementById('nameField').classList.toggle('hidden', !isLogin);
        });

        // Handle auth form submission
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const isLogin = authTitle.textContent === 'Login';
            const endpoint = isLogin ? '/api/login' : '/api/register';
            const data = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            if (!isLogin) {
                data.name = document.getElementById('name').value;
            }

            const authError = document.getElementById('authError');
            const authLoading = document.getElementById('authLoading');
            authError.classList.add('hidden');
            authLoading.classList.remove('hidden');

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                authLoading.classList.add('hidden');

                if (!response.ok) {
                    authError.textContent = result.error || 'Authentication failed';
                    authError.classList.remove('hidden');
                    return;
                }

                if (isLogin) {
                    farmerId = result.farmer_id;
                    switchTab('farm-input');
                    document.getElementById('login').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.querySelectorAll('.navbar-tabs a').forEach(a => a.classList.remove('hidden'));
                } else {
                    authError.textContent = result.message;
                    authError.classList.remove('text-red-500');
                    authError.classList.add('text-green-500');
                    authError.classList.remove('hidden');
                }
            } catch (err) {
                authLoading.classList.add('hidden');
                authError.textContent = 'Network error occurred';
                authError.classList.remove('hidden');
            }
        });

        // Toggle soil input
        function toggleSoilInput() {
            const soilOption = document.getElementById('soilOption').value;
            document.getElementById('manualSoil').classList.toggle('hidden', soilOption !== 'manual');
            document.getElementById('sensorSoil').classList.toggle('hidden', soilOption !== 'sensor');
            document.getElementById('soilType').required = soilOption === 'manual';
            ['r', 'g', 'b', 'ph', 'ec'].forEach(id => {
                document.getElementById(id).required = soilOption === 'sensor';
            });
        }

        // Handle farm form submission
        document.getElementById('farmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const farmError = document.getElementById('farmError');
            const farmLoading = document.getElementById('farmLoading');
            farmError.classList.add('hidden');
            farmLoading.classList.remove('hidden');

            if (!farmerId) {
                farmError.textContent = 'Please login to submit farm details';
                farmError.classList.remove('hidden');
                farmLoading.classList.add('hidden');
                return;
            }

            farmData = {
                farmer_id: farmerId,
                location: document.getElementById('location').value,
                land_size: parseFloat(document.getElementById('landSize').value),
                soil_option: document.getElementById('soilOption').value,
                start_date: document.getElementById('startDate').value,
                water_available: parseFloat(document.getElementById('waterAvailable').value) || 0
            };

            if (farmData.soil_option === 'manual') {
                farmData.soil_type = document.getElementById('soilType').value;
            } else {
                farmData.r = parseInt(document.getElementById('r').value) || 0;
                farmData.g = parseInt(document.getElementById('g').value) || 0;
                farmData.b = parseInt(document.getElementById('b').value) || 0;
                farmData.ph = parseFloat(document.getElementById('ph').value) || 0;
                farmData.ec = parseFloat(document.getElementById('ec').value) || 0;
            }

            try {
                const response = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(farmData)
                });
                const result = await response.json();
                farmLoading.classList.add('hidden');

                if (!response.ok) {
                    farmError.textContent = result.error || 'Failed to get recommendations';
                    farmError.classList.remove('hidden');
                    return;
                }

                soilType = result.soil_type;
                document.getElementById('soilType').textContent = `Soil Type: ${soilType}`;
                const recommendationsList = document.getElementById('recommendationsList');
                recommendationsList.innerHTML = result.recommendations.map(r => `
                    <div class="crop-card p-4 rounded-lg flex flex-col items-center bg-white">
                        <img src="${r.image_url}" alt="${r.crop}" class="crop-image mb-2" onerror="this.src='https://via.placeholder.com/100';">
                        <h4 class="font-bold text-lg text-green-800">${r.crop}</h4>
                        <p class="text-gray-600">Nutrients: ${r.nutrients} kg/acre</p>
                        <p class="text-gray-600">Water: ${r.water_requirement} L/acre</p>
                        <p class="text-gray-600">Cost: ${r.cost}</p>
                        <p class="text-gray-600">Yield: ${r.yield}</p>
                        <p class="text-gray-600">Market Trend: ${r.market_trend}</p>
                        <button class="select-crop bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 mt-2 w-full" data-crop="${r.crop}">Select</button>
                    </div>
                `).join('');

                document.getElementById('recommendations-tab').classList.remove('hidden');
                switchTab('recommendations');
            } catch (err) {
                farmLoading.classList.add('hidden');
                farmError.textContent = 'Failed to connect to server: ' + err.message;
                farmError.classList.remove('hidden');
            }
        });

        // Handle crop selection and navigate to schedule
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('select-crop')) {
                selectedCrop = e.target.dataset.crop;
                document.getElementById('schedule-tab').classList.remove('hidden');
                document.getElementById('moisture-tab').classList.remove('hidden');
                switchTab('schedule');
                updateProgress();
            }
        });

        // Generate water schedule
        document.getElementById('generateWaterSchedule').addEventListener('click', async () => {
            if (!selectedCrop) {
                alert('Please select a crop first');
                return;
            }
            try {
                const response = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        farmer_id: farmerId,
                        crop: selectedCrop,
                        soil_type: soilType,
                        land_size: farmData.land_size,
                        start_date: farmData.start_date,
                        water_available: farmData.water_available
                    })
                });
                const result = await response.json();
                if (!response.ok) {
                    alert('Failed to generate water schedule: ' + result.error);
                    return;
                }
                document.getElementById('waterSchedule').innerHTML = `
                    <table class="w-full border-collapse border">
                        <thead>
                            <tr class="bg-green-100">
                                <th class="border p-2 text-green-800">Day</th>
                                <th class="border p-2 text-green-800">Time</th>
                                <th class="border p-2 text-green-800">Water Quantity (L)</th>
                                <th class="border p-2 text-green-800">Method</th>
                                <th class="border p-2 text-green-800">Speed</th>
                                <th class="border p-2 text-green-800">Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.water_schedule.map(s => `
                                <tr>
                                    <td class="border p-2">${s.day}</td>
                                    <td class="border p-2">${s.time}</td>
                                    <td class="border p-2">${s.water_quantity}</td>
                                    <td class="border p-2">${s.method}</td>
                                    <td class="border p-2">${s.speed}</td>
                                    <td class="border p-2">${s.duration}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                alert('Failed to connect to server: ' + err.message);
            }
        });

        // Generate nutrient schedule
        document.getElementById('generateNutrientSchedule').addEventListener('click', async () => {
            if (!selectedCrop) {
                alert('Please select a crop first');
                return;
            }
            try {
                const response = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        farmer_id: farmerId,
                        crop: selectedCrop,
                        soil_type: soilType,
                        land_size: farmData.land_size,
                        start_date: farmData.start_date,
                        water_available: farmData.water_available
                    })
                });
                const result = await response.json();
                if (!response.ok) {
                    alert('Failed to generate nutrient schedule: ' + result.error);
                    return;
                }
                document.getElementById('nutrientSchedule').innerHTML = `
                    <table class="w-full border-collapse border">
                        <thead>
                            <tr class="bg-green-100">
                                <th class="border p-2 text-green-800">Week Start</th>
                                <th class="border p-2 text-green-800">Nutrient Quantity (kg)</th>
                                <th class="border p-2 text-green-800">Type</th>
                                <th class="border p-2 text-green-800">Application Method</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.nutrient_schedule.map(s => `
                                <tr>
                                    <td class="border p-2">${s.week_start}</td>
                                    <td class="border p-2">${s.nutrient_quantity}</td>
                                    <td class="border p-2">${s.type}</td>
                                    <td class="border p-2">${s.application_method}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                alert('Failed to connect to server: ' + err.message);
            }
        });

        // Update moisture level every 10 minutes
        async function updateMoisture() {
            if (!farmerId) return;
            try {
                const response = await fetch(`/api/monitor?farmer_id=${farmerId}`);
                const result = await response.json();
                if (!response.ok) {
                    document.getElementById('moistureLevel').innerHTML = `<p class="text-red-500">Failed to fetch moisture: ${result.error}</p>`;
                    return;
                }
                const now = new Date().toLocaleTimeString();
                document.getElementById('moistureLevel').innerHTML = `
                    <p class="text-gray-700"><strong>Moisture Level:</strong> ${result.moisture}</p>
                    <p class="text-gray-700"><strong>Motor Status:</strong> ${result.motor_status}</p>
                    <p class="text-gray-700"><strong>Water Supplied:</strong> ${result.water_supplied} L</p>
                `;
                document.getElementById('lastUpdated').textContent = `Last updated: ${now}`;
            } catch (err) {
                document.getElementById('moistureLevel').innerHTML = `<p class="text-red-500">Network error: ${err.message}</p>`;
            }
        }

        // Initial moisture update and set interval
        if (farmerId) updateMoisture();
        setInterval(updateMoisture, 10 * 60 * 1000); // Every 10 minutes

        // Check motor status
        document.getElementById('checkMotorStatus').addEventListener('click', async () => {
            if (!farmerId) return;
            try {
                const response = await fetch(`/api/monitor?farmer_id=${farmerId}`);
                const result = await response.json();
                if (!response.ok) {
                    alert('Failed to fetch monitoring data: ' + result.error);
                    return;
                }

                document.getElementById('motorStatus').innerHTML = `
                    <p class="text-gray-700"><strong>Moisture Level:</strong> ${result.moisture}</p>
                    <p class="text-gray-700"><strong>Motor Status:</strong> ${result.motor_status}</p>
                    <p class="text-gray-700"><strong>Water Supplied:</strong> ${result.water_supplied} L</p>
                `;

                document.getElementById('notificationsList').innerHTML = result.notifications.map(n => `
                    <div class="p-4 mb-2 rounded-lg ${n.type === 'warning' ? 'bg-yellow-100' : 'bg-blue-100'}">
                        <p class="text-gray-700">${n.message}</p>
                    </div>
                `).join('');
                updateProgress();
            } catch (err) {
                alert('Monitoring network error: ' + err.message);
            }
        });

        // Update crop stage
        document.getElementById('updateStageBtn').addEventListener('click', async () => {
            if (!selectedCrop) {
                alert('Please select a crop first');
                return;
            }
            const newStage = document.getElementById('updateStage').value;
            try {
                const response = await fetch('/api/update_stage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        farmer_id: farmerId,
                        stage: newStage,
                        selected_crop: selectedCrop
                    })
                });
                const result = await response.json();
                if (!response.ok) {
                    alert('Failed to update stage: ' + result.error);
                    return;
                }
                document.getElementById('progressBar').innerHTML = `
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-green-600 h-4 rounded-full" style="width: ${result.progress}%"></div>
                    </div>
                `;
                document.getElementById('currentStage').textContent = `Current Stage: ${result.stage}`;
                alert('Crop stage updated successfully');
            } catch (err) {
                alert('Failed to update stage: ' + err.message);
            }
        });

        // Tab switching
        function switchTab(tabId) {
            document.querySelectorAll('#tab-content > div').forEach(div => div.classList.add('hidden'));
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('text-green-200', 'underline'));
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById(`${tabId}-tab`).classList.add('text-green-200', 'underline');
        }

        document.querySelectorAll('nav a').forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab(a.id.replace('-tab', ''));
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            farmerId = null;
            selectedCrop = null;
            soilType = null;
            farmData = null;
            document.getElementById('farm-input').classList.add('hidden');
            document.getElementById('login').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('authForm').reset();
            authTitle.textContent = 'Login';
            toggleAuth.textContent = 'Register instead';
            document.getElementById('nameField').classList.add('hidden');
            document.querySelectorAll('.navbar-tabs a').forEach(a => a.classList.add('hidden'));
            switchTab('login');
        });

        // Update crop progress based on start date
        function updateProgress() {
            if (!farmData?.start_date || !selectedCrop) return;
            const start = new Date(farmData.start_date);
            const now = new Date();
            const daysElapsed = Math.floor((now - start) / (1000 * 60 * 60 * 24));
            let stage, progress;

            if (daysElapsed < 10) {
                stage = 'Seedling';
                progress = 10;
            } else if (daysElapsed < 30) {
                stage = 'Vegetative Growth';
                progress = 30;
            } else if (daysElapsed < 60) {
                stage = 'Flowering';
                progress = 60;
            } else if (daysElapsed < 90) {
                stage = 'Fruiting';
                progress = 80;
            } else {
                stage = 'Harvesting';
                progress = 100;
            }

            document.getElementById('progressBar').innerHTML = `
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="bg-green-600 h-4 rounded-full" style="width: ${progress}%"></div>
                </div>
            `;
            document.getElementById('currentStage').textContent = `Current Stage: ${stage} (${daysElapsed} days elapsed)`;
        }

        // Initial load
        window.onload = () => {
            const farmForm = document.getElementById('farmForm');
            if (!farmForm) console.error('Farm form not found');
            else console.log('Farm form loaded successfully');
        };
    </script>
</body>
</html>
